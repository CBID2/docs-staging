---
title: Physical Import Mode
summary: Learn about the physical import mode in TiDB Lightning.
---

# 物理インポートモード {#physical-import-mode}

物理インポートモードは、SQLインターフェイスを経由せずに、キーと値のペアとしてデータをTiKVノードに直接挿入する効率的で高速なインポートモードです。最大100TBのデータをインポートするのに適しています。

物理インポートモードを使用する前に、必ず[要件と制限](#requirements-and-restrictions)をお読みください。

## 実装 {#implementation}

1.  データをインポートする前に、 TiDB Lightningは自動的にTiKVノードを「インポートモード」に切り替えます。これにより、書き込みパフォーマンスが向上し、PDのスケジューリングと自動圧縮が停止します。

2.  `tidb-lightning`は、ターゲットデータベースにテーブルスキーマを作成し、メタデータをフェッチします。

3.  各テーブルは複数の連続する**ブロック**に分割されているため、Lightningは大きなテーブル（200 GB以上）からデータデータを並列にインポートできます。

4.  `tidb-lightning`は、キーと値のペアを処理するために、各ブロックの「エンジンファイル」を準備します。 `tidb-lightning`はSQLダンプを並行して読み取り、データソースをTiDBと同じエンコーディングのキーと値のペアに変換し、キーと値のペアを並べ替えて、ローカルの一時ストレージファイルに書き込みます。

5.  エンジンファイルが書き込まれると、 `tidb-lightning`はターゲットTiKVクラスタでデータの分割とスケジュール設定を開始し、次にデータをTiKVクラスタにインポートします。

    エンジンファイルには、**データエンジン**と<strong>インデックスエンジン</strong>の2種類のエンジンが含まれています。各エンジンは、キーと値のペアのタイプ（行データとセカンダリインデックス）に対応しています。通常、行データはデータソースで完全に順序付けられており、セカンダリインデックスは順序付けされていません。したがって、データエンジンファイルは対応するブロックが書き込まれた直後にインポートされ、すべてのインデックスエンジンファイルはテーブル全体がエンコードされた後にのみインポートされます。

6.  すべてのエンジンファイルがインポートされた後、 `tidb-lightning`はローカルデータソースとダウンストリームクラスタ間のチェックサムを比較し、インポートされたデータが破損していないことを確認します。次に、 `tidb-lightning`は新しいデータ（ `ANALYZE` ）を分析して、将来の操作を最適化します。一方、 `tidb-lightning`は、将来の競合を防ぐために`AUTO_INCREMENT`の値を調整します。

    自動インクリメントIDは、行数の**上限**によって推定され、テーブルデータファイルの合計サイズに比例します。したがって、自動インクリメントIDは通常、実際の行数よりも大きくなります。 ID [必ずしも隣接しているとは限りません](/mysql-compatibility.md#auto-increment-id)が自動インクリメントされるため、これは正常です。

7.  すべての手順が完了すると、 `tidb-lightning`は自動的にTiKVノードを「通常モード」に切り替え、TiDBクラスタは通常どおりサービスを提供できます。

## 要件と制限 {#requirements-and-restrictions}

### 環境要件 {#environment-requirements}

**オペレーティングシステム**：

新しいCentOS7インスタンスを使用することをお勧めします。仮想マシンは、ローカルホストまたはクラウドのいずれかにデプロイできます。 TiDB Lightningはデフォルトで必要なだけのCPUリソースを消費するため、専用サーバーにデプロイすることをお勧めします。これが不可能な場合は、他のTiDBコンポーネント（tikv-serverなど）と一緒に単一のサーバーにデプロイしてから、 TiDB LightningからのCPU使用率を制限するように`region-concurrency`を構成できます。通常、サイズは論理CPUの75％に構成できます。

**メモリとCPU** ：

パフォーマンスを向上させるには、32コアを超えるCPUと64GiBを超えるメモリを割り当てることをお勧めします。

> **ノート：**
>
> 大量のデータをインポートする場合、1回の同時インポートで約2GiBのメモリが消費される可能性があります。合計メモリ使用量は`region-concurrency * 2 GiB`にすることができます。 `region-concurrency`は、デフォルトで論理CPUの数と同じです。メモリサイズ（GiB）がCPUの2倍未満であるか、インポート中にOOMが発生する場合は、 `region-concurrency`を減らしてOOMを回避できます。

**ストレージ**： `sorted-kv-dir`構成項目は、ソートされたKey-Valueファイルの一時ストレージディレクトリを指定します。ディレクトリは空である必要があり、ストレージスペースはインポートするデータセットのサイズよりも大きい必要があります。インポートのパフォーマンスを向上させるには、 `data-source-dir`とは異なるディレクトリを使用し、そのディレクトリにフラッシュストレージと排他的I/Oを使用することをお勧めします。

**ネットワーク**：10Gbpsイーサネットカードをお勧めします。

### バージョン要件 {#version-requirements}

-   TiDB Lightning &gt;=v4.0.3。
-   TiDB&gt;=v4.0.0。
-   ターゲットTiDBクラスタがv3.x以前の場合、データのインポートを完了するには、インポーターバックエンドを使用する必要があります。このモードでは、 `tidb-lightning`は解析されたキーと値のペアをgRPC経由で`tikv-importer`に送信する必要があり、 `tikv-importer`はデータのインポートを完了します。

### 制限事項 {#limitations}

-   本番環境のTiDBクラスターにデータをインポートするために物理インポートモードを使用しないでください。パフォーマンスに深刻な影響を及ぼします。
-   デフォルトでは、複数のTiDB Lightningインスタンスを使用して同じTiDBクラスタにデータをインポートしないでください。代わりに[並列インポート](/tidb-lightning/tidb-lightning-distributed-import.md)を使用してください。
-   複数のTiDB Lightningを使用して同じターゲットにデータをインポートする場合は、バックエンドを混在させないでください。つまり、物理インポートモードと論理インポートモードを同時に使用しないでください。
-   1つのLightningプロセスで、最大10TBの単一のテーブルをインポートできます。並列インポートでは、最大10個のLightningインスタンスを使用できます。

### 他のコンポーネントで使用するためのヒント {#tips-for-using-with-other-components}

-   TiDB Lightningを使用する場合は、次の点に注意してください。

    -   テーブルのTiFlashレプリカを作成したかどうかに関係なく、 TiDB Lightningを使用してデータをテーブルにインポートできます。ただし、インポートには通常のインポートよりも時間がかかる場合があります。インポート時間は、 TiDB Lightningがデプロイされているサーバーのネットワーク帯域幅、TiFlashノードのCPUとディスクの負荷、およびTiFlashレプリカの数に影響されます。

-   TiDB Lightning文字セット：

    -   TiDB Lightningより前のTiDBLightningは、 `charset=GBK`のテーブルをインポートできません。

-   TiDB Lightningを使用する場合、以下ではありません。

    -   TiCDCは、物理インポートモードで挿入されたデータをキャプチャできません。
